# Hourglass transformer configuration for time-series diffusion (EEG) data.
[settings]
config = "~/git/signal-diffusion/config/default.toml"
trainer = "diffusion"

[data]
output_type = "db-only"  # Not used for timeseries
data_type = "timeseries"

[dataset]
name = "/data/data/signal-diffusion/processed/reweighted_timeseries_meta_dataset_n2048_fs125"
train_split = "train"
val_split = "validation"
batch_size = 64
num_workers = 4
resolution = 2048  # Sequence length (must match preprocessing nsamps)
class_column = ""
num_classes = 4

[dataset.extras]
n_eeg_channels = 20  # SEED channel count; set manually when stats are missing
sequence_length = 2048  # Explicitly match resolution for timeseries runs
gaussian_noise_std = 0.001  # Set to 0 to disable augmentation

[model]
name = "hourglass"
sample_size = 2048
conditioning = "gend_hlth_age"  # none, caption, classes

[model.extras]
mapping_width = 256
mapping_depth = 2
mapping_d_ff = 768
mapping_cond_dim = 0
mapping_dropout_rate = 0.0
depths = [3, 3, 4]
widths = [128, 256, 512]
d_ffs = [768, 768, 768]
self_attns = [
    { type = "neighborhood", d_head = 64, kernel_size = 7 },
    { type = "neighborhood", d_head = 64, kernel_size = 7 },
    { type = "global", d_head = 64 }
]
dropout_rate = [0.05, 0.05, 0.05]
augment_wrapper = false
augment_prob = 0.0
patch_size = [1, 8]  # Asymmetric patches: (channels, timesteps)
in_channels = 1  # Single channel for time-series (B, 1, n_channels, n_samples)
out_channels = 1
cfg_dropout = 0.1

[model.lora]
enabled = false

[objective]
prediction_type = "vector_field"
num_timesteps = 1000

[optimizer]
name = "adamw"
learning_rate = 1e-4
weight_decay = 1e-4
betas = [0.9, 0.999]

[scheduler]
name = "constant_with_warmup"
warmup_steps = 100

[training]
seed = 42
epochs = 100
mixed_precision = "bf16"
gradient_checkpointing = true
gradient_accumulation_steps = 2
gradient_clip_norm = 1.0
snr_gamma = 5.0

log_every_steps = 10
checkpoint_interval = 1000
checkpoint_total_limit = 3

eval_strategy = "epoch"
eval_num_steps = 100
eval_num_examples = 8

ema_use_warmup = true
ema_inv_gamma = 1
ema_power = 0.75
ema_decay = 0.999
ema_update_after_step = 1000
compile_model = false
compile_mode = "default"

[logging]
tensorboard = true
run_name = "hourglass-timeseries"
log_dir = "runs/diffusion/tensorboard/hourglass-timeseries"
wandb_project = "signal-diffusion"

[inference]
denoising_steps = 25
cfg_scale = 2.5
